import type { PHIDOption } from "./types.js";

export const mockedOptions: PHIDOption[] = [
  {
    icon: "PowerhouseLogoSmall",
    title: "Book A",
    path: "books/book-a",
    value: "phd:baefc2a4-f9a0-4950-8161-fd8d8cc7dea7:main:public",
    description: "Book A description",
  },
  {
    icon: "PowerhouseLogoSmall",
    title: "Book B",
    path: "books/book-b",
    value: "phd:baefc2a4-f9a0-4950-8161-fd8d8cc6cdb8:main:public",
    description: "Book B description",
  },
  {
    icon: "PowerhouseLogoSmall",
    title: "Book C",
    path: "books/book-c",
    value: "phd:baefc2a4-f9a0-4950-8161-fd8d8cc5efc9:main:public",
    description: "Book C description",
  },
  {
    icon: "PowerhouseLogoSmall",
    title: "Book D",
    path: "books/book-d",
    value: "phd:baefc2a4-f9a0-4950-8161-fd8d8cc1cfe3:main:public",
    description: "Book D description",
  },
  {
    icon: "PowerhouseLogoSmall",
    title: "Book E",
    path: "books/book-e",
    value: "phd:baefc2a4-f9a0-4950-8161-fd8d8cc0bfe4:main:public",
    description: "Book E description",
  },
  {
    icon: "PowerhouseLogoSmall",
    title: "Book F",
    path: "books/book-f",
    value: "phd:baefc2a4-f9a0-4950-8161-fd8d8cbfafe5:main:public",
    description: "Book F description",
  },
  {
    icon: "PowerhouseLogoSmall",
    title: "Book G",
    path: "books/book-g",
    value: "phd:baefc2a4-f9a0-4950-8161-fd8d8cbe9fe6:main:public",
    description: "Book G description",
  },
  {
    icon: "PowerhouseLogoSmall",
    title: "Book H",
    path: "books/book-h",
    value: "phd:baefc2a4-f9a0-4950-8161-fd8d8cbd8fe7:main:public",
    description: "Book H description",
  },
  {
    icon: "PowerhouseLogoSmall",
    title: "Book I",
    path: "books/book-i",
    value: "phd:baefc2a4-f9a0-4950-8161-fd8d8cbc7fe8:main:public",
    description: "Book I description",
  },
  {
    icon: "PowerhouseLogoSmall",
    title: "Book J",
    path: "books/book-j",
    value: "phd:baefc2a4-f9a0-4950-8161-fd8d8cbb6fe9:main:public",
    description: "Book J description",
  },
  {
    icon: "PowerhouseLogoSmall",
    title: "Book K",
    path: "books/book-k",
    value: "phd:baefc2a4-f9a0-4950-8161-fd8d8cba5fea:main:public",
    description: "Book K description",
  },
  {
    icon: "PowerhouseLogoSmall",
    title: "Book L",
    path: "books/book-l",
    value: "phd:baefc2a4-f9a0-4950-8161-fd8d8cb94feb:main:public",
    description: "Book L description",
  },
  {
    icon: "PowerhouseLogoSmall",
    title: "Book M",
    path: "books/book-m",
    value: "phd:baefc2a4-f9a0-4950-8161-fd8d8cb50fef:main:public",
    description: "Book M description",
  },
  {
    icon: "PowerhouseLogoSmall",
    title: "Book N",
    path: "books/book-n",
    value: "phd://security.powerhouse.io/baefc2a4-f9a0-4950-8161-fd8d8cb4fff0",
    description: "Book N description",
  },
  {
    icon: "PowerhouseLogoSmall",
    title: "Book O",
    path: "books/book-o",
    value: "phd://ops.powerhouse.io/baefc2a4-f9a0-4950-8161-fd8d8cb3eff1",
    description: "Book O description",
  },
  {
    icon: "PowerhouseLogoSmall",
    title: "Book P",
    path: "books/book-p",
    value: "phd://marketing.powerhouse.io/baefc2a4-f9a0-4950-8161-fd8d8cb2dff2",
    description: "Book P description",
  },
  {
    icon: "PowerhouseLogoSmall",
    title: "Book Q",
    path: "books/book-q",
    value: "phd://research.powerhouse.io/baefc2a4-f9a0-4950-8161-fd8d8cb1cff3",
    description: "Book Q description",
  },
  {
    icon: "PowerhouseLogoSmall",
    title: "Book R",
    path: "books/book-r",
    value: "phd://product.powerhouse.io/baefc2a4-f9a0-4950-8161-fd8d8cb0bff4",
    description: "Book R description",
  },
  {
    icon: "PowerhouseLogoSmall",
    title: "Book S",
    path: "books/book-s",
    value: "phd://social.powerhouse.io/baefc2a4-f9a0-4950-8161-fd8d8caafff5",
    description: "Book S description",
  },
  {
    icon: "PowerhouseLogoSmall",
    title: "Book T",
    path: "books/book-t",
    value: "phd://infra.powerhouse.io/baefc2a4-f9a0-4950-8161-fd8d8ca9eff6",
    description: "Book T description",
  },
  {
    icon: "PowerhouseLogoSmall",
    title: "Book U",
    path: "books/book-u",
    value:
      "phd://sustainability.powerhouse.io/baefc2a4-f9a0-4950-8161-fd8d8ca8eff7",
    description: "Book U description",
  },
  {
    icon: "PowerhouseLogoSmall",
    title: "Book V",
    path: "books/book-v",
    value: "phd://cloud.powerhouse.io/baefc2a4-f9a0-4950-8161-fd8d8ca7eff8",
    description: "Book V description",
  },
  {
    icon: "PowerhouseLogoSmall",
    title: "Book W",
    path: "books/book-w",
    value: "phd://analytics.powerhouse.io/baefc2a4-f9a0-4950-8161-fd8d8ca6eff9",
    description: "Book W description",
  },
  {
    icon: "PowerhouseLogoSmall",
    title: "Book X",
    path: "books/book-x",
    value: "phd://devops.powerhouse.io/baefc2a4-f9a0-4950-8161-fd8d8ca5effa",
    description: "Book X description",
  },
  {
    icon: "PowerhouseLogoSmall",
    title: "Book Y",
    path: "books/book-y",
    value: "phd://api.powerhouse.io/baefc2a4-f9a0-4950-8161-fd8d8ca4effb",
    description: "Book Y description",
  },
];

const filterOptions = (
  options: PHIDOption[],
  userInput: string,
  context?: Record<string, unknown>,
) => {
  const normalizedInput = userInput.toLowerCase();
  const allowUris = context?.allowUris as boolean;
  const allowedScopes = Array.isArray(context?.allowedScopes)
    ? context.allowedScopes
    : [];

  return options.filter((opt) => {
    const isUrl = opt.value.startsWith("phd://");

    if (!isUrl && !allowUris) {
      return false;
    }

    if (!isUrl && allowedScopes.length > 0) {
      const scope = opt.value.split(":").pop();
      if (scope && !allowedScopes.includes(scope)) {
        return false;
      }
    }

    const pathText = typeof opt.path === "object" ? opt.path.text : opt.path;

    return (
      opt.title?.toLowerCase().includes(normalizedInput) ||
      pathText?.toLowerCase().includes(normalizedInput) ||
      opt.value.toLowerCase().includes(normalizedInput) ||
      opt.description?.toLowerCase().includes(normalizedInput)
    );
  });
};

// Async versions
export const fetchOptions = async (
  userInput: string,
  context?: Record<string, unknown>,
): Promise<PHIDOption[]> => {
  // Simulate 2s network delay
  await new Promise((resolve) => setTimeout(resolve, 2000));

  // Add 20% chance of error
  if (Math.random() < 0.2) {
    throw new Error();
  }

  return filterOptions(mockedOptions, userInput, context);
};

export const fetchSelectedOption = async (
  value: string,
): Promise<PHIDOption | undefined> => {
  // Simulate 2s network delay
  await new Promise((resolve) => setTimeout(resolve, 2000));
  return mockedOptions.find((option) => option.value === value);
};

// Sync versions
export const fetchOptionsSync = (
  userInput: string,
  context?: Record<string, unknown>,
): PHIDOption[] => {
  return filterOptions(mockedOptions, userInput, context);
};

export const fetchSelectedOptionSync = (
  value: string,
): PHIDOption | undefined => {
  return mockedOptions.find((option) => option.value === value);
};
